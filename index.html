/**
 * GLOBAL 2050 - SOVEREIGN OS SYSTEM LOGIC
 * Version: Solid-2050.Build.01 (Ultimate Edition)
 * INTEGRATED WITH: index.html (ES-RFS Standard)
 */

// --- 1. GLOBAL CONFIGURATIONS ---
const LOCAL_NODE_IP = "http://192.168.8.102:3000";
const SYSTEM_VERSION = "2050.SOLID";
let temporarySeed = ""; 
let temporaryAddress = "";
let isNodeOnline = false;

// --- 2. EXTENDED SIDEBAR DATA ---
const SIDEBAR_DATA = {
    'ETHICAL': {
        title: 'ES-RFS: Ethical Algorithm',
        badge: 'Moral Core',
        body: `
            <div class="space-y-6">
                <p class="text-gray-400 text-sm leading-relaxed">Protokol Etika 2050 menetapkan piawaian di mana setiap transaksi ditapis melalui 'Moral Compass' digital.</p>
                <div class="p-4 bg-emerald-500/5 border border-emerald-500/20 rounded-xl">
                    <h4 class="text-xs font-bold text-emerald-500 mb-2 uppercase">Proof of Impact (PoI)</h4>
                    <p class="text-[11px] text-gray-400">Hanya transaksi yang memberikan impak positif kepada ekosistem sosial dibenarkan melepasi lapisan konsensus.</p>
                </div>
            </div>`
    },
    'STANDALONE': {
        title: 'Sovereign Stand-alone OS',
        badge: 'Infrastructure',
        body: `
            <div class="space-y-6">
                <div class="flex justify-between items-center p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                    <div>
                        <div class="text-[10px] text-blue-400 font-black uppercase">Mesh Status</div>
                        <div class="text-xl font-mono text-white">OFFLINE-FIRST</div>
                    </div>
                    <div class="h-3 w-3 bg-blue-500 animate-ping rounded-full"></div>
                </div>
                <p class="text-gray-400 text-xs">Sistem operasi ini berfungsi 100% tanpa internet melalui Local Mesh Hub.</p>
            </div>`
    },
    'REGEN': {
        title: 'Regenerative Economics',
        badge: 'Natural Capital',
        body: `
            <div class="space-y-6">
                <div class="p-6 bg-gradient-to-br from-emerald-600/20 to-transparent border border-emerald-500/20 rounded-2xl text-center">
                    <div class="text-4xl font-light text-white mb-2 tracking-tighter">14,204</div>
                    <div class="text-[9px] text-emerald-500 font-black uppercase tracking-widest">Carbon Credits Restored</div>
                </div>
            </div>`
    }
};

// --- 3. SOVEREIGN CRYPTO ENGINE (PQC SHA-512) ---
async function deriveAddressFromSeed(seed) {
    const encoder = new TextEncoder();
    const data = encoder.encode(seed + "SOVEREIGN_2050_SALT");
    const hashBuffer = await window.crypto.subtle.digest('SHA-512', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const fullHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return "VRT_PQC_" + fullHash.substring(0, 48).toUpperCase();
}

// --- 4. CORE BRIDGE ENGINE ---
async function executeSovereignAction(type, payload = {}) {
    const address = localStorage.getItem('vrt_address');
    if (!address) {
        alert("⚠️ AMARAN: Sila aktifkan Wallet Sovereign anda terlebih dahulu.");
        return;
    }
    console.log(`[Bridge] Executing ${type}...`);
    try {
        const response = await fetch(`${LOCAL_NODE_IP}/api/execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ from: address, type: type, ...payload })
        });
        const result = await response.json();
        if (result.success) {
            alert(`✅ BERJAYA: ${type}\nTX: ${result.txHash || 'SECURE_LOG'}`);
            syncWalletData(); 
        }
    } catch (error) {
        console.error("Node Connection Failed", error);
        alert("❌ NODE OFFLINE: Transaksi disimpan secara lokal dalam fail ES-RFS.");
    }
}

// --- 5. WALLET UI & SYNC ---
async function createNewSovereignWallet() {
    const entropy = window.crypto.getRandomValues(new Uint8Array(32));
    temporarySeed = Array.from(entropy).map(b => b.toString(16).padStart(2, '0')).join('');
    temporaryAddress = await deriveAddressFromSeed(temporarySeed);
    
    // Paparkan Seed untuk disalin
    alert("SEED PHRASE ANDA:\n\n" + temporarySeed + "\n\nSILA SALIN SEGERA!");
    document.getElementById('seed-modal')?.classList.remove('hidden');
}

async function verifyAndActivate() {
    const input = document.getElementById('seed-input-verify').value.trim();
    if (input === temporarySeed) {
        localStorage.setItem('vrt_address', temporaryAddress);
        localStorage.setItem('vrt_seed', temporarySeed);
        updateWalletUI(temporaryAddress);
        closeSeedModal();
    } else {
        alert("❌ Seed tidak sah.");
    }
}

function updateWalletUI(address) {
    document.getElementById('wallet-setup-actions')?.classList.add('hidden');
    document.getElementById('wallet-active-info')?.classList.remove('hidden');
    const displayAddr = document.getElementById('display-address');
    if (displayAddr) displayAddr.innerText = address;
    syncWalletData();
}

async function syncWalletData() {
    const address = localStorage.getItem('vrt_address');
    if (!address) return;
    try {
        const res = await fetch(`${LOCAL_NODE_IP}/api/balance/${address}`);
        const data = await res.json();
        document.getElementById('wallet-balance-github').innerText = data.balance.toFixed(8);
        document.getElementById('node-status-text-footer').innerText = "NODE ONLINE | ES-RFS ACTIVE";
    } catch (e) {
        // Fallback jika node offline
        document.getElementById('node-status-text-footer').innerText = "STAND-ALONE_ACTIVE (OFFLINE)";
    }
}

// --- 6. VISUALS: THREE.JS GLOBE ---
let scene, camera, renderer, globe;
function initVisuals() {
    const container = document.getElementById('globe-viewport');
    if (!container) return;
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const geometry = new THREE.SphereGeometry(2.8, 50, 50);
    const material = new THREE.PointsMaterial({ color: 0x10b981, size: 0.02, transparent: true, opacity: 0.4 });
    globe = new THREE.Points(geometry, material);
    scene.add(globe);
    camera.position.z = 8;

    function animate() {
        requestAnimationFrame(animate);
        if(globe) globe.rotation.y += 0.001;
        renderer.render(scene, camera);
    }
    animate();
}

// --- 7. BOOT & INITIALIZATION ---
window.onload = () => {
    console.log(`System Booting v${SYSTEM_VERSION}`);
    initVisuals();
    
    // Intersection Observer untuk animasi '.reveal'
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('active');
        });
    }, { threshold: 0.1 });
    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    // Pastikan list produk dijana (Gold/Tanah)
    if (window.renderProducts) window.renderProducts();

    const savedAddr = localStorage.getItem('vrt_address');
    if (savedAddr) updateWalletUI(savedAddr);
};

// --- 8. UTILITIES ---
function openSidebar(key) {
    const sidebar = document.getElementById('sovereign-sidebar');
    const content = document.getElementById('sidebar-dynamic-content');
    const data = SIDEBAR_DATA[key];
    if (data && content) {
        content.innerHTML = `
            <div class="p-8">
                <div class="text-emerald-500 text-[10px] font-black tracking-widest uppercase mb-2">${data.badge}</div>
                <h2 class="text-3xl font-bold mb-6">${data.title}</h2>
                <div class="text-gray-400">${data.body}</div>
            </div>`;
    }
    sidebar?.classList.add('open');
}

function closeSidebar() { document.getElementById('sovereign-sidebar')?.classList.remove('open'); }
function closeSeedModal() { document.getElementById('seed-modal')?.classList.add('hidden'); }
function showImportUI() { document.getElementById('import-modal')?.classList.remove('hidden'); }

async function processImport() {
    const input = document.getElementById('import-seed-input').value.trim();
    if (input.length > 20) {
        const addr = await deriveAddressFromSeed(input);
        localStorage.setItem('vrt_address', addr);
        localStorage.setItem('vrt_seed', input);
        updateWalletUI(addr);
        document.getElementById('import-modal').classList.add('hidden');
    }
}
